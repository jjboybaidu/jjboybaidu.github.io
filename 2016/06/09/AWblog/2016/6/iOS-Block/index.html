<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="阿汶"><link rel="icon" href="/hexo.png"><title>阿汶的博客</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="阿汶的博客" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">阿汶的博客</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/twoyao/beautiful-hexo">Github</a></li><li><a href="/about/">About</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/hexo.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>iOS-Block</h1><p class="post-meta">Posted on Jun 9 2016</p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><h2 id="Block有什么用？"><a href="#Block有什么用？" class="headerlink" title="Block有什么用？"></a>Block有什么用？</h2><p>1.代替类</p>
<p>2.什么时候代替类，当类只有一个函数的时候</p>
<h2 id="Block的本质？"><a href="#Block的本质？" class="headerlink" title="Block的本质？"></a>Block的本质？</h2><p>1.类和闭包的本质是一样的</p>
<p>2.类和闭包哪个好用：答案是类</p>
<p>3.Block的另一个名字闭包</p>
<p>4.block、代码块、闭包，都是只一样的玩意，是一个GCC 非常模糊的特性，以及 Clang 也有的特性是</p>
<p>5.Block是带有自动变量的匿名函数；匿名函数顾名思义就是不带名字的函数，在C语言中不允许这样的方法存在，而在OC中的Block则可以用指针来直接调用一个函数，但虽说如此我们还是需要知道指针的名称。</p>
<p>6.自动变量在Block中的具体表现就是截获自动变量</p>
<h2 id="一个标准的Block"><a href="#一个标准的Block" class="headerlink" title="一个标准的Block"></a>一个标准的Block</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">^ NSString *(NSString *a,NSString *b)&#123;</span><br><span class="line">return a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">* “^”这个符号表示这是一个Block；</span><br><span class="line"></span><br><span class="line">* 返回值类型：NSString *表示返回值。</span><br><span class="line"></span><br><span class="line">* 参数列表：(NSString a,NSString b)这个括号中是Block的参数，语法和C语言类似</span><br><span class="line"></span><br><span class="line">* 变量名在哪里？</span><br></pre></td></tr></table></figure>
<h2 id="Block调用"><a href="#Block调用" class="headerlink" title="Block调用"></a>Block调用</h2><p>1.Block调用1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">int b = 0;// 初始化b变量</span><br><span class="line">void (^blockName)() = ^&#123;</span><br><span class="line">NSLog(@&quot;Input:b=%d&quot;,b);//打印b变量</span><br><span class="line">&#125;;</span><br><span class="line">b = 3;// 对b变量进行修改，无法修改，原因如下</span><br><span class="line">blockName();// 调用blockName</span><br><span class="line"></span><br><span class="line">原因：虽然我们在调用blockName之前改变了b的值，但是输出的还是blockName编译时候b的值，所以截获瞬间自动变量就是：在blockName中会保存变量的值，而不会随变量的值的改变而改变。</span><br></pre></td></tr></table></figure>
<p>2.Block调用2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">int b = 0;</span><br><span class="line">void (^blockName)() = ^&#123;</span><br><span class="line">b = 3;</span><br><span class="line">&#125;;</span><br><span class="line">这段代码编译出错，编译器提示的大概就是不能在Block中改变变量的值。因为在Block中截获了变量的瞬间值以后就不能再改变变量的值，如果想要在Block中改变变量的值，那么我们只需要在变量声明的时候加上__Block修饰符，像这样：</span><br><span class="line"></span><br><span class="line">__block int b = 0;</span><br><span class="line">void (^blockName)() = ^&#123;</span><br><span class="line">b = 3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Block使用技巧"><a href="#Block使用技巧" class="headerlink" title="Block使用技巧"></a>Block使用技巧</h2><p>1.修改闭包内部变量注意，如果该变量在Block外部，需要在变量前面加上__block关键字</p>
<p>2.在Block中常常会用到weakSelf和strong来处理block的产生循环引用的问题</p>
<p>3.代码块如果在闭合的圆括号内的话，会返回最后语句的值;例子中返回的是url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">NSURL *url = (&#123;</span><br><span class="line">NSString *urlString = [NSString stringWithFormat:@&quot;%@/%@&quot;, baseURLString, endpoint];</span><br><span class="line">[NSURL URLWithString:urlString];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>4.在Block中不可以对C语言数组进行操作，原因是：不支持</p>
<p>5.Block可以定义在方法内部，也可以定义在方法外部；</p>
<p>6.只有调用Block时候，才会执行其内部方法</p>
<h2 id="weakSelf和strongSelf"><a href="#weakSelf和strongSelf" class="headerlink" title="weakSelf和strongSelf"></a>weakSelf和strongSelf</h2><ul>
<li><p>直接在 block 里面使用关键词 self</p>
</li>
<li><p>在 block 外定义一个 __weak 的 引用到 self，并且在 block 里面使用这个弱引用</p>
</li>
<li><p>在 block 外定义一个 <strong>weak 的 引用到 self，并在在 block 内部通过这个弱引用定义一个 </strong>strong 的引用。</p>
</li>
<li><p>注意：当 block并没有被self对象所引用 时，一般可以直接使用self</p>
</li>
<li><p>weakSelf和strongSelf的选择是：如果block不是属性则使用self；是属性但block中调用单个self的方法时用weakSelf；多个方法用strongSelf</p>
</li>
</ul>
<h2 id="使用weakSelf"><a href="#使用weakSelf" class="headerlink" title="使用weakSelf"></a>使用weakSelf</h2><p>1.持有Block；completionHandler是一个Block；被self调用，那正常来说，block里面不能用self调用方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MyViewController *myController = [[MyViewController alloc] init];</span><br><span class="line">[self presentViewController:myController animated:YES completion:self.completionHandler];// 这里是self对block持有</span><br></pre></td></tr></table></figure>
<p>2.当block对象被self持有时，一定要使用weakself避免循环引用,下面的weakSelf如果换成了self就会循环引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">__weak typeof(self) weakSelf = self;</span><br><span class="line">self.completionHandler = ^&#123; // self.completionHandler表示self调用了block，block里面又使用self，用weakSelf替换</span><br><span class="line">NSLog(@&quot;%@&quot;, weakSelf);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>3.来一个没有使用weakSelf导致运行循环的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[self executeBlock:^(NSData *data, NSError *error) &#123;</span><br><span class="line">[self doSomethingWithData:data];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="使用strongSelf"><a href="#使用strongSelf" class="headerlink" title="使用strongSelf"></a>使用strongSelf</h2><p>1.参考《解决Block循环引用》</p>
<p>2.什么时候使用weakSelf和strongSelf：参考《weakSelf和strongSelf》</p>
<p>3.多个方法用strongSelf</p>
<h2 id="解决Block循环引用"><a href="#解决Block循环引用" class="headerlink" title="解决Block循环引用"></a>解决Block循环引用</h2><p>1.什么时候会出现循环引用？简单来说就是双边引用, 如果block是self类的property (此时self已经retain了block), 然后在block内又引用了self, 这个情况下就肯定会循环引用了</p>
<p>2.在block体内define一个strong的self, 然后执行的时候判断下self是否还在, 如果在就继续执行下面的操作, 否则return或抛出异常.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">__weak typeof(self) weakSelf = self;</span><br><span class="line">myObj.myBlock =  ^&#123;</span><br><span class="line">__strong typeof(self) strongSelf = weakSelf;</span><br><span class="line">if (strongSelf) &#123;</span><br><span class="line">[strongSelf doSomething]; // strongSelf != nil</span><br><span class="line">// preemption, strongSelf still not nil</span><br><span class="line">[strongSelf doSomethingElse]; // strongSelf != nil</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">// Probably nothing...</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>3.来一个使用strongSelf错误的例子,因为block里面调用了多个方法，所以建议用strongSelf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">__weak __typeof(self)weakSelf = self;</span><br><span class="line">[self executeBlock:^(NSData *data, NSError *error) &#123;</span><br><span class="line">[weakSelf doSomethingWithData:data];</span><br><span class="line">[weakSelf doSomethingWithData:data];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.weakSelf和strongSelf的选择是：如果block不是属性则使用self；是属性但block中调用单个self的方法时用weakSelf；多个方法用strongSelf</p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/2016/07/02/AWblog/2016/7/iOS-Thread/" data-toggle="tooltip" data-placement="top" title="iOS-Thread">← Previous Post</a></li><li class="next"><a href="/2016/06/04/AWblog/2016/6/iOS分类-协议-扩展-代理-数据源/" data-toggle="tooltip" data-placement="top" title="iOS分类/协议/扩展/代理/数据源">Next Post →</a></li></ul><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts = window.location.href.split("?");
var disqus_url = url_parts[0];
(function () {
    console.log("enter disqus");
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = "//twoyao.disqus.com/embed.js";
    (document.head || d.body ).appendChild(dsq);
})();</script></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/twoyao" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="/atom.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-rss"></i></span></a></li><li><a href="https://twitter.com/twoyao_" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="mailto:bisyao@gmail.com" title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-envelope"></i></span></a></li></ul><p class="copyright text-muted">© 阿汶 • 2016 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>